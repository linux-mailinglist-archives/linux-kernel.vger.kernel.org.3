Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id 4E325500B1B
	for <lists+linux-kernel@lfdr.de>; Thu, 14 Apr 2022 12:30:03 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S242281AbiDNKcV (ORCPT <rfc822;lists+linux-kernel@lfdr.de>);
        Thu, 14 Apr 2022 06:32:21 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:33802 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S239652AbiDNKcS (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 14 Apr 2022 06:32:18 -0400
Received: from foss.arm.com (foss.arm.com [217.140.110.172])
        by lindbergh.monkeyblade.net (Postfix) with ESMTP id 0B93D3BA5F;
        Thu, 14 Apr 2022 03:29:53 -0700 (PDT)
Received: from usa-sjc-imap-foss1.foss.arm.com (unknown [10.121.207.14])
        by usa-sjc-mx-foss1.foss.arm.com (Postfix) with ESMTP id 71846139F;
        Thu, 14 Apr 2022 03:29:53 -0700 (PDT)
Received: from [10.32.36.25] (e121896.Emea.Arm.com [10.32.36.25])
        by usa-sjc-imap-foss1.foss.arm.com (Postfix) with ESMTPSA id D8A723F5A1;
        Thu, 14 Apr 2022 03:29:50 -0700 (PDT)
Message-ID: <9ad30442-41f8-6e17-cb4a-ab102b3ebd69@arm.com>
Date:   Thu, 14 Apr 2022 11:29:48 +0100
MIME-Version: 1.0
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:91.0) Gecko/20100101
 Thunderbird/91.7.0
Subject: Re: [PATCH v2] perf report: Set PERF_SAMPLE_DATA_SRC bit for Arm SPE
 event
Content-Language: en-US
To:     Arnaldo Carvalho de Melo <acme@kernel.org>,
        Leo Yan <leo.yan@linaro.org>
Cc:     Peter Zijlstra <peterz@infradead.org>,
        Ingo Molnar <mingo@redhat.com>,
        Mark Rutland <mark.rutland@arm.com>,
        Alexander Shishkin <alexander.shishkin@linux.intel.com>,
        Jiri Olsa <jolsa@kernel.org>,
        Namhyung Kim <namhyung@kernel.org>,
        Ravi Bangoria <ravi.bangoria@linux.ibm.com>,
        German Gomez <german.gomez@arm.com>,
        linux-perf-users@vger.kernel.org, linux-kernel@vger.kernel.org
References: <20220413092317.756022-1-leo.yan@linaro.org>
 <Yld4fzWWY07ksB+5@kernel.org>
From:   James Clark <james.clark@arm.com>
In-Reply-To: <Yld4fzWWY07ksB+5@kernel.org>
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 7bit
X-Spam-Status: No, score=-9.4 required=5.0 tests=BAYES_00,NICE_REPLY_A,
        RCVD_IN_DNSWL_HI,SPF_HELO_NONE,SPF_PASS,T_SCC_BODY_TEXT_LINE
        autolearn=ham autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org



On 14/04/2022 02:27, Arnaldo Carvalho de Melo wrote:
> Em Wed, Apr 13, 2022 at 05:23:17PM +0800, Leo Yan escreveu:
>> Since commit bb30acae4c4d ("perf report: Bail out --mem-mode if mem info
>> is not available") "perf mem report" and "perf report --mem-mode"
>> don't report result if the PERF_SAMPLE_DATA_SRC bit is missed in sample
>> type.
>>
>> The commit ffab48705205 ("perf: arm-spe: Fix perf report --mem-mode")
>> partially fixes the issue.  It adds PERF_SAMPLE_DATA_SRC bit for Arm SPE
>> event, this allows the perf data file generated by kernel v5.18-rc1 or
>> later version can be reported properly.
>>
>> On the other hand, perf tool still fails to be backward compatibility
>> for a data file recorded by an older version's perf which contains Arm
>> SPE trace data.  This patch is a workaround in reporting phase, when
>> detects ARM SPE PMU event and without PERF_SAMPLE_DATA_SRC bit, it will
>> force to set the bit in the sample type and give a warning info.
>>
>> Fixes: bb30acae4c4d ("perf report: Bail out --mem-mode if mem info is not available")
>> Signed-off-by: Leo Yan <leo.yan@linaro.org>
>> Tested-by: German Gomez <german.gomez@arm.com>
>> ---
>> v2: Change event name from "arm_spe_" to "arm_spe";
>>     Add German's test tag.
> 
> Tentatively applied, would be great to have James' and Ravi's
> Acked-by/Reviewed-by, which I'll add before pushing this out if provided
> in time.
> 
> - Arnaldo
>  
>>  tools/perf/builtin-report.c | 16 ++++++++++++++++
>>  1 file changed, 16 insertions(+)
>>
>> diff --git a/tools/perf/builtin-report.c b/tools/perf/builtin-report.c
>> index 1ad75c7ba074..acb07a4a9b67 100644
>> --- a/tools/perf/builtin-report.c
>> +++ b/tools/perf/builtin-report.c
>> @@ -353,6 +353,7 @@ static int report__setup_sample_type(struct report *rep)
>>  	struct perf_session *session = rep->session;
>>  	u64 sample_type = evlist__combined_sample_type(session->evlist);
>>  	bool is_pipe = perf_data__is_pipe(session->data);
>> +	struct evsel *evsel;
>>  
>>  	if (session->itrace_synth_opts->callchain ||
>>  	    session->itrace_synth_opts->add_callchain ||
>> @@ -407,6 +408,21 @@ static int report__setup_sample_type(struct report *rep)
>>  	}
>>  
>>  	if (sort__mode == SORT_MODE__MEMORY) {
>> +		/*
>> +		 * FIXUP: prior to kernel 5.18, Arm SPE missed to set
>> +		 * PERF_SAMPLE_DATA_SRC bit in sample type.  For backward
>> +		 * compatibility, set the bit if it's an old perf data file.
>> +		 */
>> +		evlist__for_each_entry(session->evlist, evsel) {
>> +			if (strstr(evsel->name, "arm_spe") &&
>> +				!(sample_type & PERF_SAMPLE_DATA_SRC)) {
>> +				ui__warning("PERF_SAMPLE_DATA_SRC bit is not set "
>> +					    "for Arm SPE event.\n");

Looks ok to me. Personally I would remove the warning, otherwise people are going to start
thinking that they need to do something about it or something bad has happened.

But because we've fixed it up there shouldn't really need to be a warning or any action.

I don't feel too strongly about this though, so I will leave it up to Leo to make the
final decision:

Reviewed-by: James Clark <james.clark@arm.com>

>> +				evsel->core.attr.sample_type |= PERF_SAMPLE_DATA_SRC;
>> +				sample_type |= PERF_SAMPLE_DATA_SRC;
>> +			}
>> +		}
>> +
>>  		if (!is_pipe && !(sample_type & PERF_SAMPLE_DATA_SRC)) {
>>  			ui__error("Selected --mem-mode but no mem data. "
>>  				  "Did you call perf record without -d?\n");
>> -- 
>> 2.25.1
> 
