Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id F0B664A4F17
	for <lists+linux-kernel@lfdr.de>; Mon, 31 Jan 2022 19:59:39 +0100 (CET)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1358028AbiAaS7e (ORCPT <rfc822;lists+linux-kernel@lfdr.de>);
        Mon, 31 Jan 2022 13:59:34 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:43382 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1357719AbiAaS7c (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 31 Jan 2022 13:59:32 -0500
Received: from mail-io1-xd2a.google.com (mail-io1-xd2a.google.com [IPv6:2607:f8b0:4864:20::d2a])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id E0DD7C061714
        for <linux-kernel@vger.kernel.org>; Mon, 31 Jan 2022 10:59:31 -0800 (PST)
Received: by mail-io1-xd2a.google.com with SMTP id e79so18145299iof.13
        for <linux-kernel@vger.kernel.org>; Mon, 31 Jan 2022 10:59:31 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=google.com; s=20210112;
        h=mime-version:references:in-reply-to:from:date:message-id:subject:to
         :cc;
        bh=5576y/uQCXE8/yygMPsGRt8dITzimXAGCknhLMYuNeI=;
        b=U5MI8d9ojjlSGVp50yOzrupxoaN1j+4cd0xjZZQecBW+DobnWXwp4ouq0fJj6JsSOn
         0gT+45WyuFTfdzXTqMVO10pnUwEiQLliE7t/xEHSnVP3hIjcKKeGm8KQyma3qwzCWq98
         ZxiWr/hwE2EEAh3uI05rYPliYC2OLcX5OGZNeM+7+3mNeg0X5qn1oHx4WFAYBSxRVdmY
         8FyerrcJf6Y2undwBiEK6d5A3L6BvjtHp45mxPaVnRo5vCUW/OE/qj8dH/Flcfhpgo1D
         MYmuopPHzs4o59r9bxVRxyvO0GKLrfdHdSQ+oCdmPmaxaW/E+Y4sHUX35i5qTQQADJe6
         E28A==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20210112;
        h=x-gm-message-state:mime-version:references:in-reply-to:from:date
         :message-id:subject:to:cc;
        bh=5576y/uQCXE8/yygMPsGRt8dITzimXAGCknhLMYuNeI=;
        b=F+8Ldt7RcleRB6y0g4AX9Uaq2VxImTjn5g/o9iGDsYtaMz+o7asvyxGV4Sq04lop1/
         gKaKkxfmfYdOG3Fv13VuOkp1+nUJOe4lgvfHXAo8TYzpRmbJw+NJp8HVVcgrJ8cY4wVa
         CJutS+GNjkE3Y556h4e5gggx5T66Nd4CCunhI84+88gaqkSVRXud3aVcSlJ/KTAIL5yU
         U73ie0tJzPcN6SeW1nWMsfVq42kx1qtJQL/VESxhafg2Rv0s9FE3cCF0b2TgDCNBB9sY
         T9NnLIBCFMsfsZMfiBteRi8PHKrFbSTXDMqzdbIFqMui+qbwmrT3SYQ34rBDs6Xpf+Ai
         ksJg==
X-Gm-Message-State: AOAM532kqiJfBOkHf8uH6ULh/Tkq04tkA9gc4QSxFTaerUJek0HtZ+jD
        41KR68+WQ8jk2sCP+OcvAxJP1ogsH0N1FC1YNeaNWg==
X-Google-Smtp-Source: ABdhPJxoYkuin5gMw7XtDRRzYfnqDSDk8vkQeiXZzYr3QseAyudPCDVtm0qgYz5KRLxrwNdoRgXJkLtiNlCXBcL2tgE=
X-Received: by 2002:a5e:de46:: with SMTP id e6mr12154112ioq.32.1643655571122;
 Mon, 31 Jan 2022 10:59:31 -0800 (PST)
MIME-Version: 1.0
References: <20220129080929.837293-1-irogers@google.com> <20220129080929.837293-4-irogers@google.com>
 <c574f164-e1f4-0166-492d-b5feaf219f54@linux.intel.com>
In-Reply-To: <c574f164-e1f4-0166-492d-b5feaf219f54@linux.intel.com>
From:   Ian Rogers <irogers@google.com>
Date:   Mon, 31 Jan 2022 10:59:19 -0800
Message-ID: <CAP-5=fWRq4WEYcZCskP+DRy0p1XOH+5mp_2L9YPi8+wjWeJsKA@mail.gmail.com>
Subject: Re: [PATCH 03/26] perf vendor events: Update metrics for Broadwell DE
To:     "Liang, Kan" <kan.liang@linux.intel.com>
Cc:     Zhengjun Xing <zhengjun.xing@linux.intel.com>,
        Peter Zijlstra <peterz@infradead.org>,
        Ingo Molnar <mingo@redhat.com>,
        Arnaldo Carvalho de Melo <acme@kernel.org>,
        Mark Rutland <mark.rutland@arm.com>,
        Alexander Shishkin <alexander.shishkin@linux.intel.com>,
        Jiri Olsa <jolsa@redhat.com>,
        Namhyung Kim <namhyung@kernel.org>,
        Maxime Coquelin <mcoquelin.stm32@gmail.com>,
        Alexandre Torgue <alexandre.torgue@foss.st.com>,
        Andi Kleen <ak@linux.intel.com>,
        James Clark <james.clark@arm.com>,
        John Garry <john.garry@huawei.com>,
        linux-kernel@vger.kernel.org, linux-perf-users@vger.kernel.org,
        Stephane Eranian <eranian@google.com>
Content-Type: text/plain; charset="UTF-8"
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Mon, Jan 31, 2022 at 5:54 AM Liang, Kan <kan.liang@linux.intel.com> wrote:
>
>
>
> On 1/29/2022 3:09 AM, Ian Rogers wrote:
> > Based on TMA_metrics-full.csv version 4.3 at 01.org:
> >      https://download.01.org/perfmon/
> > Events are still at version 7:
> >      https://download.01.org/perfmon/BDW-DE
> > Json files generated by:
> >      https://github.com/intel/event-converter-for-linux-perf
> >
> > This adds TopdownL1_SMT metrics to bdwde-metrics.json as
> > generated by the extract-tmam.py script.
> >
> > Tested:
> > ...
> >    6: Parse event definition strings                                  : Ok
> >    7: Simple expression parser                                        : Ok
> > ...
> >    9: Parse perf pmu format                                           : Ok
> >   10: PMU events                                                      :
> >   10.1: PMU event table sanity                                        : Ok
> >   10.2: PMU event map aliases                                         : Ok
> >   10.3: Parsing of PMU event table metrics                            : Skip (some metrics failed)
> >   10.4: Parsing of PMU event table metrics with fake PMUs             : Ok
> > ...
> >   68: Parse and process metrics                                       : Ok
> > ...
> >   88: perf stat metrics (shadow stat) test                            : Ok
> >   89: perf all metricgroups test                                      : FAILED!
> >   90: perf all metrics test                                           : FAILED!
> >   91: perf all PMU test                                               : Ok
> > ...
> > The failures/skips relate to:
> > event syntax error: '{arb/event=0x84,umask=0x1,metric-id=arb!3event!20x84!0umask!20x1!3/,arb/even..'
> >                       \___ Cannot find PMU `arb'. Missing kernel support?
> >
>
> ARB is an uncore unit for client platforms. Broadwell DE should be a
> server platform. It looks like an issue of TMA_metrics-full.csv.
> I will check and see whether we can fix the TMA file.

I modified the TMA_Metrics-full.csv to change the BDX column to be
BDX/BDW-DE and the BDW/BDW-DE column to be BDW. Doing this and then
applying a corresponding change to extract-tma-metrics.py (below)
created a perf json metric file that passed all the tests. I will
resend the generated files in a v2.

Thanks,
Ian

```
diff --git a/extract-tma-metrics.py b/extract-tma-metrics.py
index ed22e05..5c872ba 100755
--- a/extract-tma-metrics.py
+++ b/extract-tma-metrics.py
@@ -93,16 +93,16 @@ ratio_column = {
     "IVB": ("IVB", "SNB", ),
     "HSW": ("HSW", "IVB", "SNB", ),
     "HSX": ("HSX", "HSW", "IVT", "IVB", "JKT/SNB-EP", "SNB"),
-    "BDW/BDW-DE": ("BDW/BDW-DE", "HSW", "IVB", "SNB", ),
-    "BDX": ("BDX", "BDW/BDW-DE", "HSX", "HSW", "IVT", "IVB",
"JKT/SNB-EP", "SNB"),
+    "BDW": ("BDW", "HSW", "IVB", "SNB", ),
+    "BDX/BDW-DE": ("BDX/BDW-DE", "BDW", "HSX", "HSW", "IVT", "IVB",
"JKT/SNB-EP", "SNB"),
     "SNB": ("SNB", ),
     "JKT/SNB-EP": ("JKT/SNB-EP", "SNB"),
-    "SKL/KBL": ("SKL/KBL", "BDW/BDW-DE", "HSW", "IVB", "SNB"),
-    "SKX": ("SKX", "SKL/KBL", "BDX", "BDW/BDW-DE", "HSX", "HSW",
"IVT", "IVB", "JKT/SNB-EP", "SNB"),
-    "KBLR/CFL": ("KBLR/CFL", "SKL/KBL", "BDW/BDW-DE", "HSW", "IVB", "SNB"),
-    "CLX": ("CLX", "KBLR/CFL/CML", "SKX", "SKL/KBL", "BDX",
"BDW/BDW-DE", "HSX", "HSW", "IVT", "IVB", "JKT/SNB-EP", "SNB"),
-    "ICL": ("ICL", "CNL", "KBLR/CFL/CML", "SKL/KBL", "BDW/BDW-DE",
"HSW", "IVB", "SNB"),
-    "ICX": ("ICX", "ICL", "CNL", "CPX", "CLX", "KBLR/CFL/CML", "SKX",
"SKL/KBL", "BDX", "BDW/BDW-DE", "HSX", "HSW", "IVT", "IVB",
"JKT/SNB-EP", "SNB"),
+    "SKL/KBL": ("SKL/KBL", "BDW", "HSW", "IVB", "SNB"),
+    "SKX": ("SKX", "SKL/KBL", "BDX/BDW-DE", "BDW", "HSX", "HSW",
"IVT", "IVB", "JKT/SNB-EP", "SNB"),
+    "KBLR/CFL": ("KBLR/CFL", "SKL/KBL", "BDW", "HSW", "IVB", "SNB"),
+    "CLX": ("CLX", "KBLR/CFL/CML", "SKX", "SKL/KBL", "BDX/BDW-DE",
"BDW", "HSX", "HSW", "IVT", "IVB", "JKT/SNB-EP", "SNB"),
+    "ICL": ("ICL", "CNL", "KBLR/CFL/CML", "SKL/KBL", "BDW", "HSW",
"IVB", "SNB"),
+    "ICX": ("ICX", "ICL", "CNL", "CPX", "CLX", "KBLR/CFL/CML", "SKX",
"SKL/KBL", "BDX/BDW-DE", "BDW", "HSX", "HSW", "IVT", "IVB",
"JKT/SNB-EP", "SNB"),
 }

 ap = argparse.ArgumentParser()
```

> Thanks,
> Kan
>
> > Signed-off-by: Ian Rogers<irogers@google.com>
> > ---
> >   .../arch/x86/broadwellde/bdwde-metrics.json   |  401 +++-
> >   .../arch/x86/broadwellde/cache.json           | 1122 +++++-----
> >   .../arch/x86/broadwellde/floating-point.json  |  222 +-
> >   .../arch/x86/broadwellde/frontend.json        |  335 +--
> >   .../arch/x86/broadwellde/memory.json          |  608 +++---
> >   .../arch/x86/broadwellde/other.json           |   28 +-
> >   .../arch/x86/broadwellde/pipeline.json        | 1892 ++++++++---------
> >   .../arch/x86/broadwellde/virtual-memory.json  |  394 ++--
> >   8 files changed, 2646 insertions(+), 2356 deletions(-)
