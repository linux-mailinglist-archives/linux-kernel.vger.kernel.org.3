Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from vger.kernel.org (vger.kernel.org [23.128.96.18])
	by mail.lfdr.de (Postfix) with ESMTP id 927ED4A35B3
	for <lists+linux-kernel@lfdr.de>; Sun, 30 Jan 2022 11:28:53 +0100 (CET)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1354597AbiA3K2t (ORCPT <rfc822;lists+linux-kernel@lfdr.de>);
        Sun, 30 Jan 2022 05:28:49 -0500
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:59260 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1354443AbiA3K2o (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Sun, 30 Jan 2022 05:28:44 -0500
Received: from dfw.source.kernel.org (dfw.source.kernel.org [IPv6:2604:1380:4641:c500::1])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id AE4EBC061714;
        Sun, 30 Jan 2022 02:28:44 -0800 (PST)
Received: from smtp.kernel.org (relay.kernel.org [52.25.139.140])
        (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
        (No client certificate requested)
        by dfw.source.kernel.org (Postfix) with ESMTPS id 578F461134;
        Sun, 30 Jan 2022 10:28:44 +0000 (UTC)
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 8FD29C340E4;
        Sun, 30 Jan 2022 10:28:43 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=k20201202; t=1643538523;
        bh=JScouu7QJzKlX9zxN9+gJC2kurFCaqhYhzCffJo5CmY=;
        h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
        b=UO1SMJcNJgX2LrIsWjjT4ryauQ1+KZ1t4buAgyl08ZK9ezEUsorn/xeZNdyEJlSrO
         eIm8CHvEVOJLGXMoYNPBu1QJuFBUX8bKG/T9Zb4bH5e1s05R7KeuRMExjHKwxjUkY4
         93Ad77S1psNZY/tBpaw+E6a59SLOtloEnP0jA34G1gDYgNrG9aZ3gsq9M1lM37lv9s
         jErY1u1XUd7ZvHfOlJPLznacSu0fAa5fR7Jqpgz26/AAWpBXFppcmnsBYYNEbleSI7
         2NeFt7YSLeSu0QJTB93G4wTBr9zkcyAF6PURU3Vc914nRE3kjkx3odTpyJprt9AoZS
         RshTaMiOqgUew==
Received: from sofa.misterjones.org ([185.219.108.64] helo=wait-a-minute.misterjones.org)
        by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        (Exim 4.94.2)
        (envelope-from <maz@kernel.org>)
        id 1nE7Rp-00493J-K8; Sun, 30 Jan 2022 10:28:41 +0000
Date:   Sun, 30 Jan 2022 10:28:41 +0000
Message-ID: <87o83ty0ti.wl-maz@kernel.org>
From:   Marc Zyngier <maz@kernel.org>
To:     Guo Ren <guoren@kernel.org>
Cc:     Samuel Holland <samuel@sholland.org>,
        Anup Patel <anup@brainfault.org>,
        Thomas Gleixner <tglx@linutronix.de>,
        Palmer Dabbelt <palmer@dabbelt.com>,
        Linux Kernel Mailing List <linux-kernel@vger.kernel.org>,
        linux-riscv <linux-riscv@lists.infradead.org>,
        devicetree <devicetree@vger.kernel.org>,
        Guo Ren <guoren@linux.alibaba.com>
Subject: Re: [PATCH V6 2/2] irqchip/sifive-plic: Fixup thead,c900-plic dt parse in opensbi
In-Reply-To: <CAJF2gTQsi6uT8ea6MTu6oDA-9xsd3fW5ETHAtpzGZxapLpLsWA@mail.gmail.com>
References: <20220129162726.1154501-1-guoren@kernel.org>
        <20220129162726.1154501-3-guoren@kernel.org>
        <87r18qxui9.wl-maz@kernel.org>
        <CAJF2gTTYN0bxnnMtP9L1KvaH0h6ny+Lr3+fC7GP-YWnwjAYd4A@mail.gmail.com>
        <35b1838d-ef80-1816-46f6-9cba7afc813e@sholland.org>
        <CAJF2gTQsi6uT8ea6MTu6oDA-9xsd3fW5ETHAtpzGZxapLpLsWA@mail.gmail.com>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/27.1
 (x86_64-pc-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=US-ASCII
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: guoren@kernel.org, samuel@sholland.org, anup@brainfault.org, tglx@linutronix.de, palmer@dabbelt.com, linux-kernel@vger.kernel.org, linux-riscv@lists.infradead.org, devicetree@vger.kernel.org, guoren@linux.alibaba.com
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Sun, 30 Jan 2022 04:39:34 +0000,
Guo Ren <guoren@kernel.org> wrote:
> 
> On Sun, Jan 30, 2022 at 10:50 AM Samuel Holland <samuel@sholland.org> wrote:
> >
> > On 1/29/22 8:08 PM, Guo Ren wrote:
> > > On Sun, Jan 30, 2022 at 2:32 AM Marc Zyngier <maz@kernel.org> wrote:
> > >>
> > >> On Sat, 29 Jan 2022 16:27:26 +0000,
> > >> guoren@kernel.org wrote:
> > >>>
> > >>> From: Guo Ren <guoren@linux.alibaba.com>
> > >>>
> > >>> The thead,c900-plic has been used in opensbi to distinguish
> > >>> PLIC [1]. Although PLICs have the same behaviors in Linux,
> > >>> they are different hardware with some custom initializing in
> > >>> firmware(opensbi).
> > >>>
> > >>> [1]: https://github.com/riscv-software-src/opensbi/commit/78c2b19218bd62653b9fb31623a42ced45f38ea6
> > >>>
> > >>> Signed-off-by: Guo Ren <guoren@linux.alibaba.com>
> > >>> Cc: Anup Patel <anup@brainfault.org>
> > >>> Cc: Marc Zyngier <maz@kernel.org>
> > >>> Cc: Palmer Dabbelt <palmer@dabbelt.com>
> > >>> Cc: Samuel Holland <samuel@sholland.org>
> > >>> Cc: Thomas Gleixner <tglx@linutronix.de>
> > >>> ---
> > >>>  drivers/irqchip/irq-sifive-plic.c | 25 +++++++++++++++++++++++--
> > >>>  1 file changed, 23 insertions(+), 2 deletions(-)
> > >>>
> > >>> diff --git a/drivers/irqchip/irq-sifive-plic.c b/drivers/irqchip/irq-sifive-plic.c
> > >>> index 259065d271ef..245655928076 100644
> > >>> --- a/drivers/irqchip/irq-sifive-plic.c
> > >>> +++ b/drivers/irqchip/irq-sifive-plic.c
> > >>> @@ -172,7 +172,7 @@ static void plic_irq_eoi(struct irq_data *d)
> > >>>       }
> > >>>  }
> > >>>
> > >>> -static struct irq_chip plic_chip = {
> > >>> +static struct irq_chip sifive_plic_chip = {
> > >>>       .name           = "SiFive PLIC",
> > >>>       .irq_mask       = plic_irq_mask,
> > >>>       .irq_unmask     = plic_irq_unmask,
> > >>> @@ -182,12 +182,24 @@ static struct irq_chip plic_chip = {
> > >>>  #endif
> > >>>  };
> > >>>
> > >>> +static struct irq_chip thead_plic_chip = {
> > >>> +     .name           = "T-Head PLIC",
> > >>> +     .irq_mask       = plic_irq_mask,
> > >>> +     .irq_unmask     = plic_irq_unmask,
> > >>> +     .irq_eoi        = plic_irq_eoi,
> > >>> +#ifdef CONFIG_SMP
> > >>> +     .irq_set_affinity = plic_set_affinity,
> > >>> +#endif
> > >>> +};
> > >>
> > >> For pure entertainment, let's compare the two structures:
> > >>
> > >> static struct irq_chip plic_chip = {
> > >>         .name           = "SiFive PLIC",
> > >>         .irq_mask       = plic_irq_mask,
> > >>         .irq_unmask     = plic_irq_unmask,
> > >>         .irq_eoi        = plic_irq_eoi,
> > >> #ifdef CONFIG_SMP
> > >>         .irq_set_affinity = plic_set_affinity,
> > >> #endif
> > >> };
> > >>
> > >> Oh wait: a string. Must be really important. Not.
> > > No, pls see below comment.
> > >
> > >>
> > >>> +
> > >>> +static struct irq_chip *def_plic_chip = &sifive_plic_chip;
> > >>> +
> > >>>  static int plic_irqdomain_map(struct irq_domain *d, unsigned int irq,
> > >>>                             irq_hw_number_t hwirq)
> > >>>  {
> > >>>       struct plic_priv *priv = d->host_data;
> > >>>
> > >>> -     irq_domain_set_info(d, irq, hwirq, &plic_chip, d->host_data,
> > >>> +     irq_domain_set_info(d, irq, hwirq, def_plic_chip, d->host_data,
> > >>>                           handle_fasteoi_irq, NULL, NULL);
> > >>>       irq_set_noprobe(irq);
> > >>>       irq_set_affinity(irq, &priv->lmask);
> > >>> @@ -396,5 +408,14 @@ static int __init plic_init(struct device_node *node,
> > >>>       return error;
> > >>>  }
> > >>>
> > >>> +static int __init thead_c900_plic_init(struct device_node *node,
> > >>> +             struct device_node *parent)
> > >>> +{
> > >>> +     def_plic_chip = &thead_plic_chip;
> > >>> +
> > >>> +     return plic_init(node, parent);
> > >>> +}
> > >>> +
> > >>>  IRQCHIP_DECLARE(sifive_plic, "sifive,plic-1.0.0", plic_init);
> > >>>  IRQCHIP_DECLARE(riscv_plic0, "riscv,plic0", plic_init); /* for legacy systems */
> > >>> +IRQCHIP_DECLARE(thead_c900_plic, "thead,c900-plic", thead_c900_plic_init);
> > >>
> > >> Sorry, but I can't see any point to this patch.
> > > You didn't see the link I've put in the patch. In that opensbi patch:

No. If you can't explain why you need this in the commit message, why
should I reverse engineer that from some obscure piece of firmware?

> > >                 intc: interrupt-controller@10000000 {
> > >                         #interrupt-cells = <1>;
> > > -                       compatible = "riscv,plic0";
> > > +                       compatible = "allwinner,sun20i-d1-plic",
> > > +                                    "thead,c900-plic";
> > >
> > > +#define THEAD_PLIC_CTRL_REG 0x1ffffc
> > > +
> > > +static void thead_plic_plat_init(struct plic_data *pd)
> > > +{
> > > +       writel_relaxed(BIT(0), (void *)pd->addr + THEAD_PLIC_CTRL_REG);
> > > +}
> > > +
> > >  static const struct fdt_match irqchip_plic_match[] = {
> > >         { .compatible = "riscv,plic0" },
> > >         { .compatible = "sifive,plic-1.0.0" },
> > > +       { .compatible = "thead,c900-plic",
> > > +         .data = thead_plic_plat_init },
> > >         { },
> > >  };
> > >
> > > We've changed the compatible name for thead,c900-plic, and there is no
> > > riscv,plic0 / sifive,plic-1.0.0 in dts. Without the patch, the newest
> > > opensbi + newest Linux would be broken in the Allwinner D1 dev board.

So the firmware changes things in incompatible ways. Why does it
matter to Linux? Why isn't the fix directly applied to the firmware
instead? Why isn't the riscv,plic0 fallback appropriate?

> > Yes, some patch is still necessary, because the hardware is indeed incompatible
> > with riscv,plic0. However, this driver does not care about the difference. So
> > all you need to do is hook up the existing code to the new compatible:
> >
> > +IRQCHIP_DECLARE(thead_c900_plic, "thead,c900-plic", plic_init);
> I think we should give clear info in /proc/interrupts. I hope we could
> keep thead_plic_init.

Why? There is no material difference at the driver level, and
/proc/interrupts won't be the target of a branding exercise (which
this series seems to be all about).

	M.

-- 
Without deviation from the norm, progress is not possible.
