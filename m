Return-Path: <linux-kernel-owner@vger.kernel.org>
X-Original-To: lists+linux-kernel@lfdr.de
Delivered-To: lists+linux-kernel@lfdr.de
Received: from out1.vger.email (out1.vger.email [IPv6:2620:137:e000::1:20])
	by mail.lfdr.de (Postfix) with ESMTP id 4B2ED516D65
	for <lists+linux-kernel@lfdr.de>; Mon,  2 May 2022 11:31:21 +0200 (CEST)
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1384235AbiEBJeX (ORCPT <rfc822;lists+linux-kernel@lfdr.de>);
        Mon, 2 May 2022 05:34:23 -0400
Received: from lindbergh.monkeyblade.net ([23.128.96.19]:48362 "EHLO
        lindbergh.monkeyblade.net" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1384265AbiEBJeD (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 2 May 2022 05:34:03 -0400
Received: from ams.source.kernel.org (ams.source.kernel.org [145.40.68.75])
        by lindbergh.monkeyblade.net (Postfix) with ESMTPS id B4F08E0BD
        for <linux-kernel@vger.kernel.org>; Mon,  2 May 2022 02:30:35 -0700 (PDT)
Received: from smtp.kernel.org (relay.kernel.org [52.25.139.140])
        (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
        (No client certificate requested)
        by ams.source.kernel.org (Postfix) with ESMTPS id 62355B815BE
        for <linux-kernel@vger.kernel.org>; Mon,  2 May 2022 09:30:34 +0000 (UTC)
Received: by smtp.kernel.org (Postfix) with ESMTPSA id 1C40AC385A4;
        Mon,  2 May 2022 09:30:33 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=k20201202; t=1651483833;
        bh=HTGTeq8uKlquYM7Dt4tKVhKro/OXk4ZWBJItzDvqR5o=;
        h=Date:From:To:Cc:Subject:In-Reply-To:References:From;
        b=oDrJuIScjL72QXUponKtcPCfiZE2heXmP7cLLvQtP9soOnPlnNuC/sq5dQpCWz19o
         8AIfZ9Gfh7XJA5sA4TTUT1ORaVTiIAyft31OMl6bG5rU20cniVE7eQY3CjRd9ldSE5
         9vWA5CrBZ1G6+mn47cBIDeXOd8J62wqOFQ5lObpvLPU6pD6OzNJqLjJA5vsU1UDEbj
         FXYQLePWD7ByFq94fjHmt6c66k/T88DPbmrqQI1gmKsfsswBZkEHqAljoDAcbNm0V8
         fVaIPKjrO0Ysb6v5BnpwhEFmtjx/mUaAVzkJau7QSqKMqJJz6v36ktRYZQl9fvS57X
         eXmlHFCOUI3mw==
Received: from sofa.misterjones.org ([185.219.108.64] helo=wait-a-minute.misterjones.org)
        by disco-boy.misterjones.org with esmtpsa  (TLS1.3) tls TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        (Exim 4.94.2)
        (envelope-from <maz@kernel.org>)
        id 1nlSNy-008Ntf-Gi; Mon, 02 May 2022 10:30:30 +0100
Date:   Mon, 02 May 2022 10:31:11 +0100
Message-ID: <87mtg0i8m8.wl-maz@kernel.org>
From:   Marc Zyngier <maz@kernel.org>
To:     Marek =?UTF-8?B?QmVow7pu?= <kabel@kernel.org>
Cc:     linux-kernel@vger.kernel.org, Thomas Gleixner <tglx@linutronix.de>,
        pali@kernel.org
Subject: Re: irqdomain API: how to set affinity of parent irq of chained irqs?
In-Reply-To: <20220502102137.764606ee@thinkpad>
References: <20220502102137.764606ee@thinkpad>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI-EPG/1.14.7 (Harue)
 FLIM-LB/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL-LB/10.8 EasyPG/1.0.0 Emacs/27.1
 (x86_64-pc-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI-EPG 1.14.7 - "Harue")
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: quoted-printable
X-SA-Exim-Connect-IP: 185.219.108.64
X-SA-Exim-Rcpt-To: kabel@kernel.org, linux-kernel@vger.kernel.org, tglx@linutronix.de, pali@kernel.org
X-SA-Exim-Mail-From: maz@kernel.org
X-SA-Exim-Scanned: No (on disco-boy.misterjones.org); SAEximRunCond expanded to false
X-Spam-Status: No, score=-7.7 required=5.0 tests=BAYES_00,DKIMWL_WL_HIGH,
        DKIM_SIGNED,DKIM_VALID,DKIM_VALID_AU,DKIM_VALID_EF,RCVD_IN_DNSWL_HI,
        SPF_HELO_NONE,SPF_PASS,T_SCC_BODY_TEXT_LINE autolearn=ham
        autolearn_force=no version=3.4.6
X-Spam-Checker-Version: SpamAssassin 3.4.6 (2021-04-09) on
        lindbergh.monkeyblade.net
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Mon, 02 May 2022 09:21:37 +0100,
Marek Beh=C3=BAn <kabel@kernel.org> wrote:
>=20
> Dear Marc, Thomas,
>=20
> we have encountered the following problem that can hopefully be put
> some light onto: What is the intended way to set affinity (and possibly
> other irq attributes) of parent IRQ of chained IRQs, when using the
> irqdomain API?

Simples: you can't. What sense does it make to change the affinity of
the parent interrupt, given that its fate is tied to *all* of the
other interrupts that are muxed to it?

Moving the parent interrupt breaks userspace's view of how interrupt
affinity is managed (change the affinity of one interrupt, see all the
others move the same way). Which is why we don't expose this interrupt
to userspace, as this can only lead to bad things.

Note that this has nothing to do with the irqdomain API, but
everything to do with the userspace ABI.

>=20
> We are working on a driver that
> - registers an irqchip and adds an irqdomain
> - calls irq_set_chained_handler_and_data(parent_irq, handler)
>   where handler triggers handling of child IRQs
> - but since parent_irq isn't requested for with request_thread_irq(),
>   it does not show up in proc/sysfs, only in debugfs
> - the HW does not support setting affinity for the chained IRQs, only=20
>   the parent (which comes from a GIC chip)
>=20
> The problem is that he parent IRQ, as mentioned in the third point, does
> not show up in proc/sysfs.
>=20
> Is there some precedent for this?

There were precedents of irqchips doing terrible things, such as
implementing a set_affinity() callback in the chained irqchip.
Thankfully, they have been either fixed or eradicated.

	M.

--=20
Without deviation from the norm, progress is not possible.
